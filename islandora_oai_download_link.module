<?php

define('ISLANDORA_OAI_DOWLOAD_LINK_DEFAULT_CMODEL_LINK_MAPPINGS', "islandora:sp_basic_image = OBJ\nislandora:sp_large_image_cmodel = JP2\nir:thesisCModel = PDF\nir:citationCModel = PDF\nislandora:bookCModel = PDF\nislandora:newspaperIssueCModel = PDF\nislandora:sp_pdf = OBJ\nislandora:sp_videoCModel = MP4");

/**
 * @file
 * Module file.
 */

/**
 * Implements hook_islandora_oai_identify_request_handler().
 *
 * This custom request handler reuses all of the requests defined in
 * islandora_oai_islandora_oai_identify_request_handler() other than
 * 'response_xml'.
 */
function islandora_oai_download_link_islandora_oai_identify_request_handler() {
  return array(
    'islandora_oai_download_link' => array(
      'label' => t('Islandora OAI with download links'),
      'description' => t("Adds direct download links to the OAI DC and MODS generated by the standard Islandora OAI request handler."),
      'configuration' => 'admin/islandora/tools/islandora-oai/handler',
      'requests' => array(
        'ListIdentifiers' => array(
          'file' => drupal_get_path('module', 'islandora_oai') . '/includes/handler.inc',
          'function' => 'islandora_oai_retrieve_records_or_identifiers',
        ),
        'ListRecords' => array(
          'file' => drupal_get_path('module', 'islandora_oai') . '/includes/handler.inc',
          'function' => 'islandora_oai_retrieve_records_or_identifiers',
        ),
        'ListSets' => array(
          'file' => drupal_get_path('module', 'islandora_oai') . '/includes/handler.inc',
          'function' => 'islandora_oai_retrieve_sets',
        ),
        'GetRecord' => array(
          'file' => drupal_get_path('module', 'islandora_oai') . '/includes/handler.inc',
          'function' => 'islandora_oai_retrieve_record',
        ),
        // This is the only function specific to this module.
        'response_xml' => array(
          'file' => drupal_get_path('module', 'islandora_oai_download_link') . '/includes/handler.inc',
          'function' => 'islandora_oai_download_link_object_response_xml',
        ),
        'set_membership' => array(
          'file' => drupal_get_path('module', 'islandora_oai') . '/includes/handler.inc',
          'function' => 'islandora_oai_get_membership',
        ),
      ),
    ),
  );
}

/**
 * Implements hook_form_alter().
 */
function islandora_oai_download_link_form_islandora_oai_handler_configuration_form_alter(&$form, $form_state, $form_id) {
  module_load_include('inc', 'islandora_oai_download_link', 'includes/handler');
  $form['islandora_oai_download_links'] = array(
    '#type' => 'fieldset',
    '#title' => t('Download links'),
    '#description' => t("This OAI request handler adds elements to the OAI metadata containing " .
        "direct links to download a file for each object. See the module's README for more information."),
    '#collapsible' => FALSE,
    '#collapsed' => TRUE,
  );
  $form['islandora_oai_download_links']['islandora_oai_download_link_mods_fragment'] = array(
    '#type' => 'textfield',
    '#title' => t('MODS element'),
    '#size' => 128,
    '#description' => t('The element to add the download link to. %url% is a placeholder for the link. Leave blank to not add a link.'),
      '#default_value' => variable_get('islandora_oai_download_link_mods_fragment', '<location><url access="download">%url%</url></location>'),
    '#states' => array(
      'visible' => array(
          ':input[name="islandora_oai_metadata_format"]' => array('value' => 'mods'),
        ),
     ),
  );
  $form['islandora_oai_download_links']['islandora_oai_download_link_cmodel_link_mappings'] = array(
    '#type' => 'textarea',
    '#title' => t('Content model to link mappings for download links'),
    '#description' => t('Enter mappings, one per line, indicating which datastream should be included ' .
      'in the download links provided to harvesters.'),
      '#default_value' => variable_get('islandora_oai_download_link_cmodel_link_mappings', ISLANDORA_OAI_DOWLOAD_LINK_DEFAULT_CMODEL_LINK_MAPPINGS),
  );
  $form['islandora_oai_download_links']['islandora_oai_download_link_allowed_ips'] = array(
    '#type' => 'textarea',
    '#title' => t('Allowed IP ranges for download links'),
    '#description' => t('Enter the IP address ranges in CIDR notation, ' .
      ' one per line, of harvesters that will be provided with download ' .
      ' links (for example, 192.168.100.14/24). Harvesters outside these ' .
      'ranges will not see download links in the OAI metadata. Leave empty ' .
      'to provide download links to all harvesters.'),
      '#default_value' => variable_get('islandora_oai_download_link_allowed_ips', ''),
  );
  $form['submit']['#weight'] = 10;
  $form['#submit'][] = 'islandora_oai_download_link_handler_configuration_submit';
}
